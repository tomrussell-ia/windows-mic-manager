<UserControl
    x:Class="MicrophoneManager.WinUI.Views.MicrophoneFlyout"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MicrophoneManager.WinUI.Views"
    xmlns:viewmodels="using:MicrophoneManager.Core.ViewModels"
    MinWidth="370"
    Background="#2D2D2D">

    <Grid Padding="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Microphone List -->
            <RowDefinition Height="Auto"/> <!-- Empty State -->
        </Grid.RowDefinitions>

        <!-- Header with Dock/Undock button -->
        <Grid Grid.Row="0" Margin="2,0,2,4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                      Text="Microphones"
                      FontSize="14"
                      FontWeight="SemiBold"
                      Foreground="#999999"
                      VerticalAlignment="Center"/>

            <!-- Dock / Undock button -->
            <Button Grid.Column="1"
                    x:Name="DockButton"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    Padding="4"
                    Click="DockButton_Click"
                    ToolTipService.ToolTip="Dock / Undock">
                <FontIcon x:Name="DockIcon"
                         Glyph="&#xE718;"
                         FontSize="14"
                         Foreground="#999999"/>
            </Button>
        </Grid>

        <!-- Microphone List -->
        <ScrollViewer Grid.Row="1"
                     MaxHeight="360"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{x:Bind ViewModel.Microphones, Mode=OneWay}"
                         Background="Transparent">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:MicrophoneEntryViewModel">
                        <Border Background="#3D3D3D"
                               CornerRadius="6"
                               Padding="6"
                               Margin="3,2,3,4">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/> <!-- Header -->
                                    <RowDefinition Height="Auto"/> <!-- Meter -->
                                    <RowDefinition Height="Auto"/> <!-- Volume -->
                                </Grid.RowDefinitions>

                                <!-- Header: Icon + Name + Action Buttons -->
                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <FontIcon Grid.Column="0"
                                             Glyph="&#xE720;"
                                             FontSize="18"
                                             Margin="0,0,6,0"
                                             Foreground="White"
                                             VerticalAlignment="Center"/>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Name, Mode=OneWay}"
                                                  FontWeight="SemiBold"
                                                  Foreground="White"
                                                  TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{x:Bind FormatTag, Mode=OneWay}"
                                                  FontSize="11"
                                                  Foreground="#AAAAAA"/>
                                    </StackPanel>

                                    <!-- Default/Comms action buttons -->
                                    <StackPanel Grid.Column="2"
                                               Orientation="Horizontal"
                                               Spacing="6"
                                               VerticalAlignment="Center">
                                        <Button Command="{x:Bind SetDefaultCommand}"
                                               Width="32" Height="24" Padding="0"
                                               ToolTipService.ToolTip="Set Default"
                                               Background="{StaticResource HoverBrush}">
                                            <FontIcon Glyph="&#xE720;" FontSize="13" Foreground="White"/>
                                        </Button>

                                        <Button Command="{x:Bind SetDefaultCommunicationCommand}"
                                               Width="32" Height="24" Padding="0"
                                               ToolTipService.ToolTip="Set Communications"
                                               Background="{StaticResource HoverBrush}">
                                            <FontIcon Glyph="&#xE8BD;" FontSize="13" Foreground="White"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>

                                <!-- Meter: Input Level with Peak Indicator -->
                                <Grid Grid.Row="1" Margin="0,4,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/> <!-- Label -->
                                        <RowDefinition Height="Auto"/> <!-- Meter -->
                                    </Grid.RowDefinitions>

                                    <!-- Label -->
                                    <Grid Grid.Row="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                  Text="Input"
                                                  FontSize="11"
                                                  Foreground="#AAAAAA"/>
                                        <TextBlock Grid.Column="1"
                                                  FontSize="11"
                                                  Foreground="#AAAAAA">
                                            <Run Text="{x:Bind InputLevelPercent, Mode=OneWay, Converter={StaticResource PercentFormat}}"/>
                                        </TextBlock>
                                    </Grid>

                                    <!-- Meter Bar -->
                                    <ProgressBar
                                        Grid.Row="1"
                                        Height="8"
                                        Margin="0,3,0,0"
                                        Minimum="0"
                                        Maximum="100"
                                        Value="{x:Bind InputLevelPercent, Mode=OneWay}"
                                        Background="#2D2D2D"
                                        Foreground="{StaticResource MeterGradientBrush}" />
                                </Grid>

                                <!-- Volume: Mute button + Slider -->
                                <Grid Grid.Row="2" Margin="0,4,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Button Grid.Column="0"
                                           Command="{x:Bind ToggleMuteCommand}"
                                           Width="32" Height="24" Padding="0"
                                           Margin="0,0,6,0"
                                                         ToolTipService.ToolTip="{x:Bind IsMuted, Mode=OneWay, Converter={StaticResource MuteStateToLabel}}"
                                           Background="#3D3D3D">
                                                     <FontIcon Glyph="{x:Bind IsMuted, Mode=OneWay, Converter={StaticResource MuteStateToIcon}}"
                                                 FontSize="13"
                                                 Foreground="White"/>
                                    </Button>

                                    <Slider Grid.Column="1"
                                           Minimum="0"
                                           Maximum="100"
                                           Value="{x:Bind VolumePercent, Mode=TwoWay}"/>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- No microphones message -->
        <TextBlock Grid.Row="2"
                  Text="No microphones detected"
                  Foreground="#AAAAAA"
                  Margin="4,6,0,0"
                  Visibility="{x:Bind ViewModel.HasNoMicrophones, Mode=OneWay, Converter={StaticResource BoolToVisibility}}"/>
    </Grid>
</UserControl>
